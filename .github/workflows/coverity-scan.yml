name: coverity-scan

# Controls when the action will run. 
on:
  # Triggers the workflow on push or pull request events but only for the coverity branch
  #push:
  #  branches: [ coverity ]
  #schedule:
  #  - cron: '0 18 * * *' # Daily at 18:00 UTC

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Install Libraries
        run: |
          sudo add-apt-repository -y ppa:ubuntugis/ubuntugis-unstable
          sudo apt-get update
          sudo apt-get install --allow-unauthenticated protobuf-c-compiler libprotobuf-c-dev bison flex libfribidi-dev cmake librsvg2-dev colordiff libpq-dev libpng-dev libjpeg-dev libgif-dev libgeos-dev libfreetype6-dev libfcgi-dev libcurl4-gnutls-dev libcairo2-dev libgdal-dev libproj-dev libxml2-dev libexempi-dev lcov lftp postgis libharfbuzz-dev gdal-bin ccache curl postgresql-server-dev-10 postgresql-10-postgis-3 postgresql-10-postgis-3-scripts swig
      - name: Build MapServer
        run: |
          mkdir build
          cd build
          cmake ..
      - name: Download Coverity Build Tool
        run: |
          wget -q https://scan.coverity.com/download/cxx/linux64 --post-data "token=$TOKEN&project=mapserver%2Fmapserver" -O cov-analysis-linux64.tar.gz
          mkdir cov-analysis-linux64
          tar xzf cov-analysis-linux64.tar.gz --strip 1 -C cov-analysis-linux64
        env:
          TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
      - name: Build with cov-build
        run: |
          export PATH=`pwd`/cov-analysis-linux64/bin:$PATH
          cov-build --dir cov-int make
      - name: Submit to Coverity Scan
        run: |
          tar czvf mapserver.tgz cov-int
          curl \
            --form project=mapserver%2Fmapserver \
            --form token=$TOKEN \
            --form email=steve.lime@state.mn.us \
            --form file=@mapserver.tgz \
            --form version=main \
            --form description="`./mapserv -v`" \
            https://scan.coverity.com/builds?project=mapserver%2Fmapserver
        env:
          TOKEN: ${{ secrets.COVERITY_SCAN_TOKEN }}
